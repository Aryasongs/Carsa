<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Car Parker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-100 to-slate-200 min-h-screen text-slate-800 p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="mb-8 text-center md:text-left flex flex-col md:flex-row justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">
                    <i class="fa-solid fa-wand-magic-sparkles mr-2 text-blue-600"></i>AI Object Editor
                </h1>
                <p class="text-slate-500 mt-1">Upload your scene and describe what to add</p>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Controls Section -->
            <div class="lg:col-span-4 space-y-6">
                
                <!-- Image Upload -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <label class="block text-sm font-semibold text-slate-700 mb-2">1. Upload Image</label>
                    <div id="dropzone" class="relative border-2 border-dashed border-slate-300 rounded-xl p-8 text-center hover:border-blue-500 transition-colors cursor-pointer bg-slate-50 group">
                        <input type="file" id="fileInput" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                        <div id="uploadPlaceholder" class="space-y-2">
                            <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto group-hover:scale-110 transition-transform">
                                <i class="fa-solid fa-cloud-arrow-up text-xl"></i>
                            </div>
                            <p class="text-sm text-slate-600 font-medium">Click or drag image here</p>
                            <p class="text-xs text-slate-400">JPG, PNG up to 5MB</p>
                        </div>
                        <div id="imagePreviewContainer" class="hidden relative h-48 w-full">
                            <img id="previewImage" class="w-full h-full object-contain rounded-lg" alt="Preview">
                            <button id="removeImageBtn" class="absolute top-2 right-2 bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center hover:bg-red-600 shadow-sm" title="Remove image">
                                <i class="fa-solid fa-times text-xs"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Prompt Input -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <label class="block text-sm font-semibold text-slate-700 mb-2">2. Description</label>
                    <textarea id="promptInput" rows="4" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all resize-none text-sm leading-relaxed" placeholder="Describe the edit...">Park a realistic white 2021 Toyota Fortuner car on the side of the road. The car should have the license plate number 'PB 32 AD 1417'. Ensure the lighting and shadows match the scene.</textarea>
                    <div class="mt-4">
                        <button id="generateBtn" disabled class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-slate-300 disabled:cursor-not-allowed text-white font-medium py-3 px-4 rounded-xl transition-all shadow-lg shadow-blue-600/20 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-bolt"></i>
                            <span>Generate Edit</span>
                        </button>
                    </div>
                </div>

                <!-- Instructions -->
                <div class="bg-blue-50 rounded-xl p-4 border border-blue-100">
                    <div class="flex items-start gap-3">
                        <i class="fa-solid fa-circle-info text-blue-500 mt-1"></i>
                        <p class="text-xs text-blue-700 leading-relaxed">
                            <strong>Tip:</strong> For best results, ensure the uploaded image has clear space where you want the car to appear. The AI will try to match the perspective.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="lg:col-span-8">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 h-full min-h-[500px] flex flex-col overflow-hidden relative">
                    <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-white z-10">
                        <h2 class="font-semibold text-slate-800">Result</h2>
                        <div class="flex gap-2">
                             <button id="downloadBtn" class="hidden text-sm bg-slate-100 hover:bg-slate-200 text-slate-700 py-2 px-4 rounded-lg transition-colors flex items-center gap-2">
                                <i class="fa-solid fa-download"></i> Download
                            </button>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div id="emptyState" class="flex-1 flex flex-col items-center justify-center text-slate-400 p-8">
                        <i class="fa-regular fa-image text-6xl mb-4 opacity-20"></i>
                        <p>Generated image will appear here</p>
                    </div>

                    <!-- Loading State -->
                    <div id="loadingState" class="hidden absolute inset-0 z-20 bg-white/90 backdrop-blur-sm flex flex-col items-center justify-center">
                        <div class="w-16 h-16 border-4 border-blue-100 border-t-blue-600 rounded-full animate-spin mb-4"></div>
                        <p class="text-slate-600 font-medium animate-pulse">Processing image...</p>
                        <p class="text-slate-400 text-sm mt-2">This may take 10-20 seconds</p>
                    </div>

                    <!-- Error State -->
                    <div id="errorState" class="hidden absolute inset-0 z-30 bg-white flex flex-col items-center justify-center p-8 text-center">
                        <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mb-4">
                            <i class="fa-solid fa-triangle-exclamation text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-slate-800 mb-2">Generation Failed</h3>
                        <p id="errorMessage" class="text-slate-500 max-w-md">Something went wrong. Please try again.</p>
                        <button onclick="document.getElementById('errorState').classList.add('hidden')" class="mt-6 text-blue-600 hover:text-blue-700 font-medium">Try Again</button>
                    </div>

                    <!-- Result Image -->
                    <div id="resultContainer" class="hidden flex-1 bg-slate-900 relative flex items-center justify-center overflow-auto">
                        <img id="resultImage" class="max-w-full max-h-full object-contain shadow-2xl" alt="Generated Result">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        const apiKey = ""; // Runtime provided
        
        // DOM Elements
        const fileInput = document.getElementById('fileInput');
        const dropzone = document.getElementById('dropzone');
        const uploadPlaceholder = document.getElementById('uploadPlaceholder');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const previewImage = document.getElementById('previewImage');
        const removeImageBtn = document.getElementById('removeImageBtn');
        const generateBtn = document.getElementById('generateBtn');
        const promptInput = document.getElementById('promptInput');
        const emptyState = document.getElementById('emptyState');
        const loadingState = document.getElementById('loadingState');
        const resultContainer = document.getElementById('resultContainer');
        const resultImage = document.getElementById('resultImage');
        const errorState = document.getElementById('errorState');
        const errorMessage = document.getElementById('errorMessage');
        const downloadBtn = document.getElementById('downloadBtn');

        let currentFileBase64 = null;
        let currentFileMimeType = null;

        // Utils
        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        const showError = (msg) => {
            loadingState.classList.add('hidden');
            errorState.classList.remove('hidden');
            errorMessage.textContent = msg;
        };

        // File Handling
        const handleFile = async (file) => {
            if (!file) return;
            if (file.size > 5 * 1024 * 1024) {
                alert("File is too large. Max 5MB.");
                return;
            }

            try {
                const base64Url = await toBase64(file);
                // Strip prefix for API
                const parts = base64Url.split(',');
                currentFileBase64 = parts[1];
                currentFileMimeType = parts[0].match(/:(.*?);/)[1];
                
                previewImage.src = base64Url;
                uploadPlaceholder.classList.add('hidden');
                imagePreviewContainer.classList.remove('hidden');
                generateBtn.disabled = false;
                
                // Reset result
                resultContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
                downloadBtn.classList.add('hidden');
            } catch (e) {
                console.error(e);
                alert("Error reading file.");
            }
        };

        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
        
        // Drag and drop
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('border-blue-500', 'bg-blue-50');
        });
        
        dropzone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropzone.classList.remove('border-blue-500', 'bg-blue-50');
        });
        
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('border-blue-500', 'bg-blue-50');
            handleFile(e.dataTransfer.files[0]);
        });

        removeImageBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            fileInput.value = '';
            currentFileBase64 = null;
            currentFileMimeType = null;
            imagePreviewContainer.classList.add('hidden');
            uploadPlaceholder.classList.remove('hidden');
            generateBtn.disabled = true;
        });

        // API Call
        const callGemini = async (prompt, imageBase64, mimeType) => {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        { 
                            inlineData: {
                                mimeType: mimeType,
                                data: imageBase64
                            }
                        }
                    ]
                }],
                generationConfig: {
                    responseModalities: ["TEXT", "IMAGE"]
                }
            };

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errText = await response.text();
                throw new Error(`API Error: ${response.status} - ${errText}`);
            }

            const data = await response.json();
            return data;
        };

        // Generate Action
        generateBtn.addEventListener('click', async () => {
            const prompt = promptInput.value.trim();
            if (!prompt || !currentFileBase64) return;

            loadingState.classList.remove('hidden');
            errorState.classList.add('hidden');
            emptyState.classList.add('hidden');
            resultContainer.classList.add('hidden');

            // Exponential backoff retry logic
            const maxRetries = 3;
            let attempt = 0;
            let success = false;

            while (attempt < maxRetries && !success) {
                try {
                    const data = await callGemini(prompt, currentFileBase64, currentFileMimeType);
                    
                    // Extract image
                    // The model returns base64 image data in the parts
                    const candidates = data.candidates;
                    if (candidates && candidates.length > 0) {
                        const parts = candidates[0].content.parts;
                        // Find the image part
                        const imagePart = parts.find(p => p.inlineData);
                        
                        if (imagePart) {
                            const rawBase64 = `data:${imagePart.inlineData.mimeType || 'image/png'};base64,${imagePart.inlineData.data}`;
                            
                            // Process image to add watermark
                            const tempImg = new Image();
                            tempImg.onload = () => {
                                const canvas = document.createElement('canvas');
                                canvas.width = tempImg.width;
                                canvas.height = tempImg.height;
                                const ctx = canvas.getContext('2d');
                                
                                // Draw original image
                                ctx.drawImage(tempImg, 0, 0);
                                
                                // Watermark Config
                                const text = "Oriontec Ai";
                                // Calculate responsive font size (e.g., 4% of image width)
                                const fontSize = Math.max(20, tempImg.width * 0.04); 
                                ctx.font = `bold ${fontSize}px Inter, sans-serif`;
                                ctx.textAlign = 'right';
                                ctx.textBaseline = 'bottom';
                                
                                // Shadow/Outline for visibility on any background
                                ctx.shadowColor = "rgba(0,0,0,0.8)";
                                ctx.shadowBlur = 4;
                                ctx.shadowOffsetX = 2;
                                ctx.shadowOffsetY = 2;
                                ctx.fillStyle = "rgba(255, 255, 255, 0.95)";
                                
                                // Draw Text with padding
                                const padding = Math.max(10, tempImg.width * 0.02);
                                ctx.fillText(text, canvas.width - padding, canvas.height - padding);
                                
                                const finalUrl = canvas.toDataURL('image/png');
                                
                                resultImage.src = finalUrl;
                                
                                // Setup download
                                downloadBtn.onclick = () => {
                                    const a = document.createElement('a');
                                    a.href = finalUrl;
                                    a.download = 'Oriontec_Ai_Edit.png';
                                    a.click();
                                };

                                resultContainer.classList.remove('hidden');
                                downloadBtn.classList.remove('hidden');
                                loadingState.classList.add('hidden');
                            };
                            tempImg.src = rawBase64;
                            success = true;

                        } else {
                            // Sometimes it might refuse and return only text
                             const textPart = parts.find(p => p.text);
                             if (textPart) {
                                 throw new Error("Model returned text instead of image: " + textPart.text);
                             } else {
                                 throw new Error("No image generated.");
                             }
                        }
                    } else {
                         throw new Error("No candidates returned.");
                    }

                } catch (error) {
                    console.error("Attempt " + (attempt + 1) + " failed:", error);
                    attempt++;
                    if (attempt < maxRetries) {
                        // Wait before retry (1s, 2s, 4s)
                        await new Promise(r => setTimeout(r, Math.pow(2, attempt - 1) * 1000));
                    } else {
                        showError("Failed to generate image. The model may be busy or the request was filtered. " + error.message);
                        loadingState.classList.add('hidden');
                    }
                }
            }
        });

    </script>
</body>
</html>


